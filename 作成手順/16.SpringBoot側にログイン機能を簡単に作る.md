# 🌐 ReactからSpring Bootにログイン情報を送信して認証する方法（セッションベース）

---

## ✅ やりたいこと

- Spring Boot 側でセッション認証を行いたい
- **React 側でログインフォームを作って、ユーザー情報を送信してログイン**させたい（Springの `/login` を直接見せたくない）

---

## ✅ 構成の概要

| 項目 | 内容 |
|------|------|
| 認証方式 | フォームログイン（Spring Security） |
| フロント | React 側にログインフォームを用意 |
| バックエンド | Spring Boot が `/login` エンドポイントでセッション認証を処理 |
| 通信方法 | `fetch()` + `credentials: 'include'`（クッキー送信） |

---

## ⚙️ 1. Spring Security の設定（`SecurityConfig.java`）

```js  
package com.example.simple_crud_spring.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
public class SecurityConfig {

    @Bean
    public InMemoryUserDetailsManager userDetailsService() {
        return new InMemoryUserDetailsManager(
            User.withUsername("admin@example.com").password("{noop}password123").roles("USER").build(),
            User.withUsername("user@example.com").password("{noop}password456").roles("USER").build()
        );
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf().disable()
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/login", "/logout").permitAll()
                .anyRequest().authenticated()
            )
            .formLogin(form -> form
                .loginProcessingUrl("/login") // ← ここがReactからPOST送信する先
                .successHandler((req, res, auth) -> res.setStatus(200))
                .failureHandler((req, res, ex) -> res.setStatus(401))
            )
            .logout(logout -> logout.logoutUrl("/logout"));

        return http.build();
    }
}
```
---

## 🧭 2. React 側でログインフォームを用意

```js  
import React, { useState } from 'react';

function LoginForm({ onLoginSuccess }) {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');

    const handleLogin = async (e) => {
        e.preventDefault();
        const formData = new URLSearchParams();
        formData.append('username', email);
        formData.append('password', password);

        const response = await fetch('http://localhost:8080/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            credentials: 'include',
            body: formData
        });

        if (response.ok) {
            alert("ログイン成功");
            onLoginSuccess();
        } else {
            alert("ログイン失敗");
        }
    };

    return (
        <form onSubmit={handleLogin}>
            <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="メールアドレス"
                required
            />
            <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="パスワード"
                required
            />
            <button type="submit">ログイン</button>
        </form>
    );
}

export default LoginForm;
```
---

## 🔁 3. 認証済みのAPIを呼び出す（セッション付き）

```js  
fetch('http://localhost:8080/api/posts', {
    method: 'GET',
    credentials: 'include' // ← これがないとセッション維持されない！
})
```
---

## 🔄 4. ログアウト機能の追加（任意）

```js  
fetch('http://localhost:8080/logout', {
    method: 'POST',
    credentials: 'include'
})
```
---

## ✅ メリット

- Spring Boot 側でセッションを管理するため、React 側でユーザー情報を保存しなくていい
- サーバー側がすべての認証状態を把握できるので安全性が高い

---

## 📝 補足

| 注意点 | 内容 |
|--------|------|
| パスワード送信 | HTTPSで通信しないと盗聴リスクがある（本番では必ずSSL） |
| CORS設定 | `/login` や `/logout` に対して `allowedMethods("POST")` を許可しておく |
| フォーム形式 | `application/x-www-form-urlencoded` を使うこと（JSON不可） |

---

## ✅ まとめ

Reactでログイン画面を表示し、Spring BootにPOSTでログイン情報を送り、サーバー側でセッション管理を行う構成は、**セキュリティとユーザビリティの両立**が可能な最小構成。  
この方法であれば、**ReactからSpring Bootへログイン制御を任せつつ、UIの自由度も確保できる**。
